<!DOCTYPE html>
<html lang="en">
	<head>
		<title>zip</title>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<script src="/js/vue.min.js"></script>
		<script src="/js/jszip.min.js"></script>
		<script src="/js/moment.js"></script>
		<style>
		.w-5{width:5%!important}
		.w-70{width:70%!important}
		.custom-file-control::after{content:"Select Zip..." !important;}
		.custom-file-control::before{content:"Select" !important;}
		</style>
		<link rel="stylesheet" href="/css/bootstrap.min.css">
	</head>
	<body>
		<div id="zip" class="container">
			<div class="row">
				<label class="custom-file col-md-12">
					<input type="file" v-model="zip" accept="application/zip" @change="filehandle" class="custom-file-input">
					<span class="custom-file-control"></span>
				</label>
			</div>
			<div @dragover="prevent" @drop="drop" class="row">
				<a @click="m_open" href="#">Download Selected files</a>
				<div class="col-md-12">
					<table id="list" class="table table-striped">
						<thead>
							<tr>
								<th class="w-5"><input type="checkbox" v-model="all" @change="toggle"></th>
								<th class="w-70">FileName</th>
								<th class="w-25">ModifiedTime</th>
							</tr>
						</thead>
						<tbody>
							<tr v-for="i in files" v-if="!i.dir">
								<td><input type="checkbox" v-model="i.checked" @change="oncheck"></td>
								<td><a href="#" @click="open(i.name)">{{i.name}}</a></td>
								<td>{{moment(i.data).format('YYYY/MM/DD HH:mm')}}</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
		<script>
			var a=document.createElement('a');
			moment.locale(navigator.language);
			var zip=new Vue({
				el: '#zip',
				data: {
					zip: null,
					files: {},
					check: 0,
					all: false,
					jz: null
				},
				methods: {
					filehandle(e){
						var self=this;
						this.jz=new JSZip();
						this.jz.loadAsync(e.target.files[0]).then(z=>{
							var o={};
							for(i in z.files){
								if(z.files.hasOwnProperty(i)){
									var e=z.files[i];
									o[i]={
										name: e.name,
										data: e.date,
										dir: e.dir,
										_data: e._data,
										checked: false
									};
								}
							}
							self.files=o;
						}).catch(()=>alert('failed when unzip zip file'));
					},
					open(i){
						this.jz.files[i].async('uint8array').then(d=>{
							var blob=new Blob([d]);
							a.href=window.URL.createObjectURL(blob);
							a.download=i.split('/').pop();
							document.body.appendChild(a);
							a.click();
							document.body.removeChild(a);
						});
					},
					m_open(){
						var nosel=true;
						for(i in this.files){
							if(this.files.hasOwnProperty(i)){
								if(this.files[i].checked){
									this.open(i);
									nosel=false;
								}
							}
						}
						if(nosel)alert('no file selected');
					},
					drop(e){
						this.prevent(e)
						var ee={
							target:{
								files: [e.dataTransfer.files[0]]
							}
						};
						this.filehandle(ee);
					},
					prevent(e){
						e.stopPropagation();
						e.preventDefault();
					},
					oncheck(e){
						if(e.target.checked)this.check++;
						else this.check--;
						this.all=this.check>0;
					},
					toggle(e){
						var v=e.target.checked;
						for(i in this.files){
							if(this.files.hasOwnProperty(i)){
								this.files[i].checked=v;
							}
						}
						if(!v)this.check=0;
						else this.check=Object.keys(this.files).length;
						this.all=this.check>0;
					}
				}
			});
		</script>
	</body>
</html>